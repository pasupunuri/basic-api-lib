"use strict";var effector=require("effector");const AsyncStorage=window.localStorage;function createLocalStore(e,t,o){const r=effector.createEvent(),n=effector.createEffect({handler(){var e=o?o(AsyncStorage.getItem(t)):AsyncStorage.getItem(t);return e||{}}});var a=effector.createEffect({handler(e){try{AsyncStorage.setItem(t,o?JSON.stringify(e):e,e=>{e&&console.error(e)})}catch(e){console.error(e)}}});return n.doneData.watch(e=>{r(e)}),effector.forward({from:e,to:a}),e.on(r,(e,t)=>t),n(),e}const userStore=createLocalStore(effector.createStore({}),"user-data",JSON.parse),setData=effector.createEvent(),updateInfo=effector.createEvent(),removeError=effector.createEvent();async function login(e,t,{succ:o,error:r}){post("login",{data:{email:e,password:t},auth:!1,success:e=>{console.log("data",e),setData({token:e.data.token,info:e.data.info}),o&&o(e.data.info)},error:e=>{console.log(e),setData({error:e}),r&&r(e)}})}function state(){return userStore.getState()}function authToken(){return state().token}function loggedIn(){return!!authToken()}function logout(){setData({})}userStore.on(setData,(e,t)=>t),userStore.on(updateInfo,(e,t)=>({token:e.token,info:{...e.info,...t}})),userStore.on(removeError,(e,t)=>({...e,error:null}));var user={authToken:authToken,loggedIn:loggedIn,login:login,logout:logout,userStore:userStore,removeError:removeError};const path=e=>e.includes("http")?e:"https://lmv-pos-api.herokuapp.com/api/"+e,handleError=async function(e,t){console.log(t),console.log("HANDLE ERROR"),e({status:"error",data:"Somehitng happend."})},handleResp=async function(e,t,o){console.log("HANDLE RESP",e.status,t,o),e.status<400?t(await e.json()):401===e.status?(o({code:401}),logout()):o(await e.json())},fetchWithAuth=function(e,{success:t,error:o,data:r,auth:n=!0,...a}){console.log("IN FETCHWITHAUTH"),a.headers={Authorization:authToken()},r&&(a.body=JSON.stringify({data:r}),a.headers["Content-Type"]="application/json"),!loggedIn()&&n||fetch(path(e),a).then(e=>handleResp(e,t,o),e=>handleError(o,e))};function post(e,t={}){t.method="post",fetchWithAuth(e,t)}function get(e,t={}){t.method="get",fetchWithAuth(e,t)}function put(e,t={}){t.method="put",fetchWithAuth(e,t)}function del(e,t={}){t.method="delete",fetchWithAuth(e,t)}var api={get:get,post:post,put:put,del:del},index={api:api,user:user};module.exports=index;
